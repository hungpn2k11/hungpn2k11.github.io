<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .result-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Custom modal styles */
        .modal-overlay {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
        [disabled] {
            cursor: not-allowed;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="absolute top-4 left-4">
  <a href="https://hungpn2k11.github.io/votesystem.html" class="group flex items-center justify-center gap-2 bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-lg hover:bg-gray-700 transform hover:-translate-x-1 transition-all duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-300 group-hover:-translate-x-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </svg>
    <span>Back to Vote Menu</span>
  </a>
</div>
    <!-- Password Overlay -->
    <div id="password-overlay" class="fixed inset-0 bg-gray-200 flex items-center justify-center z-50">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-4">Admin Access</h2>
            <p class="text-center text-gray-600 mb-6">Please enter the password to continue.</p>
            <div class="space-y-4">
                <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Password">
                <button id="password-btn" class="w-full bg-blue-500 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition active:scale-95">Enter</button>
                <p id="password-error" class="text-red-500 text-sm text-center h-4"></p>
            </div>
        </div>
    </div>


    <div id="app" class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8 hidden">
        <!-- Initial Loading State -->
        <div id="loading-state" class="text-center p-8 bg-white rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-gray-700">Connecting to Dashboard...</h1>
            <p class="text-gray-500 mt-2">Please wait a moment.</p>
        </div>

        <!-- Firebase Configuration Error Panel -->
        <div id="config-panel" class="hidden bg-white rounded-2xl shadow-lg p-8 mb-8">
             <h2 class="text-2xl font-bold text-red-600 mb-4">Connection Failed</h2>
             <p class="text-gray-600 mb-4">Could not connect to the Firebase project. Please check the following:</p>
             <ol class="list-decimal list-inside mb-4 text-gray-600 space-y-2">
                 <li>The `firebaseConfig` object in the HTML file is correct.</li>
                 <li>Firestore Database has been created in your Firebase project.</li>
                 <li>The database security rules allow read/write access.</li>
                 <li>Anonymous Authentication is enabled in your Firebase project.</li>
             </ol>
             <p class="text-sm text-gray-500">The manager dashboard will not function until the connection is successful.</p>
        </div>

        <!-- Main Dashboard Content -->
        <div id="main-content" class="hidden">
            <h1 class="text-4xl font-bold text-gray-800 mb-6">Voting Dashboard</h1>
    
            <!-- Results Section -->
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Live Results</h2>
                    <span id="total-votes" class="text-lg font-semibold text-gray-500">Total Votes: 0</span>
                </div>
                <div id="results-container" class="space-y-4">
                    <p class="text-gray-500">Waiting for data...</p>
                </div>
            </div>
    
            <!-- Manager Controls Section -->
            <div class="space-y-8">
                <div id="manage-options-section" class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">1. Manage Options</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-option-input" placeholder="Enter new option name" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                        <button id="add-option-btn" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition active:scale-95">Add</button>
                    </div>
                    <div id="options-list" class="space-y-2">
                        <!-- Options list will be here -->
                    </div>
                </div>
    
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">2. Poll Control</h2>
                        <div id="poll-control-section" class="space-y-3 text-center">
                           <p class="text-gray-600 mb-4">Current Status: <span id="poll-status-text" class="font-bold">...</span></p>
                           <button id="poll-control-btn" class="w-full text-white font-semibold py-2 px-4 rounded-lg transition active:scale-95"></button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">3. Post-Vote Display</h2>
                        <p class="text-gray-600 mb-4">Control what voters see after they vote.</p>
                        <div id="publish-options" class="space-y-3">
                            <!-- Radio buttons here -->
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Danger Zone</h2>
                    <p class="text-gray-600 mb-4">This will reset the entire poll, clear all votes, and return it to Draft mode.</p>
                    <button id="reset-votes-btn" class="w-full bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition active:scale-95">Reset Poll</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white w-full max-w-md p-6 rounded-2xl shadow-lg transform scale-95">
            <h3 class="text-xl font-bold text-gray-800" id="modal-title">Confirm Action</h3>
            <p class="text-gray-600 my-4" id="modal-body">Are you sure?</p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAbTL-yn9AjEdMXTREw_cs2YXtmueSiij8",
          authDomain: "votesystem-41be1.firebaseapp.com",
          projectId: "votesystem-41be1",
          storageBucket: "votesystem-41be1.appspot.com",
          messagingSenderId: "920140116787",
          appId: "1:920140116787:web:e6692cbf735254c2fc4446",
          measurementId: "G-ZM6PDF66FH"
        };
        
        // --- Password Elements ---
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const passwordBtn = document.getElementById('password-btn');
        const passwordError = document.getElementById('password-error');
        const appContainer = document.getElementById('app');
        const ADMIN_PASSWORD = 'hung';

        // --- DOM Elements ---
        const manageOptionsSection = document.getElementById('manage-options-section');
        const loadingState = document.getElementById('loading-state');
        const mainContent = document.getElementById('main-content');
        const configPanel = document.getElementById('config-panel');
        const newOptionInput = document.getElementById('new-option-input');
        const addOptionBtn = document.getElementById('add-option-btn');
        const resultsContainer = document.getElementById('results-container');
        const totalVotesEl = document.getElementById('total-votes');
        const optionsList = document.getElementById('options-list');
        const resetVotesBtn = document.getElementById('reset-votes-btn');
        const publishOptionsContainer = document.getElementById('publish-options');
        const pollStatusText = document.getElementById('poll-status-text');
        const pollControlBtn = document.getElementById('poll-control-btn');
        
        // Modal Elements
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        let confirmCallback = null;

        // --- Firebase Initialization ---
        let db;
        const POLL_ID = 'main_poll';
        let pollRef;
        
        // --- Password Logic ---
        function checkPassword() {
            if (passwordInput.value === ADMIN_PASSWORD) {
                passwordOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                initialize();
            } else {
                passwordError.textContent = 'Incorrect password.';
                passwordInput.value = '';
                setTimeout(() => passwordError.textContent = '', 2000);
            }
        }
        
        passwordBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                checkPassword();
            }
        });


        async function initialize() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                pollRef = doc(db, "polls", POLL_ID);
                const auth = getAuth(app);
                await signInAnonymously(auth);
                
                await getOrCreatePoll();
                setupListeners();

                loadingState.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                loadingState.classList.add('hidden');
                configPanel.classList.remove('hidden');
            }
        }

        // --- Core Logic ---
        async function getOrCreatePoll() {
            const docSnap = await getDoc(pollRef);
            if (!docSnap.exists()) {
                await setDoc(pollRef, { 
                    options: [],
                    pollSessionId: crypto.randomUUID(),
                    publishMode: 'hidden',
                    ballots: [],
                    pollStatus: 'draft' // draft, open, closed
                });
            }
            return docSnap.data();
        }

        function setupListeners() {
            onSnapshot(pollRef, (docSnap) => {
                if (!docSnap.exists()) return;
                const pollData = docSnap.data();
                const options = pollData.options || [];
                updateResultsUI(options);
                updateOptionsListUI(options);
                updatePublishUI(pollData.publishMode || 'hidden');
                updatePollControlUI(pollData.pollStatus || 'draft');
            });

            addOptionBtn.addEventListener('click', handleAddOption);
            resetVotesBtn.addEventListener('click', handleResetVotes);
            
            modalCancelBtn.addEventListener('click', hideModal);
            modalConfirmBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideModal();
            });
        }

        // --- UI Update Functions ---
        function updateResultsUI(options) {
            resultsContainer.innerHTML = '';
            const totalVotes = options.reduce((sum, opt) => sum + opt.votes, 0);
            totalVotesEl.textContent = `Total Votes: ${totalVotes}`;

            if (options.length === 0) {
                resultsContainer.innerHTML = `<p class="text-gray-500">No options available. Add one below to get started.</p>`;
                return;
            }
            
            options.sort((a, b) => b.votes - a.votes).forEach(option => {
                const percentage = totalVotes === 0 ? 0 : (option.votes / totalVotes) * 100;
                resultsContainer.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-700">${option.name}</span>
                            <span class="text-sm font-medium text-gray-600">${option.votes} Vote(s)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                            <div class="bg-blue-500 h-4 rounded-full result-bar-fill" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
        }

        function updateOptionsListUI(options) {
            optionsList.innerHTML = '';
            if (options.length === 0) {
                optionsList.innerHTML = `<p class="text-gray-500 text-sm">No options created yet.</p>`;
                return;
            }
            options.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-lg';
                optionEl.innerHTML = `<span class="text-gray-800">${option.name}</span>`;
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Remove';
                deleteBtn.className = 'delete-btn text-red-500 hover:text-red-700 font-semibold text-sm';
                deleteBtn.onclick = () => handleDeleteOption(option.id, option.name);
                optionEl.appendChild(deleteBtn);
                optionsList.appendChild(optionEl);
            });
        }

        function updatePublishUI(publishMode) {
            publishOptionsContainer.innerHTML = `
                <label class="flex items-center p-3 bg-gray-50 rounded-lg border has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer transition">
                    <input type="radio" name="publish-mode" value="hidden" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${publishMode === 'hidden' ? 'checked' : ''}>
                    <span class="ml-3 text-sm font-medium text-gray-800">Hide All</span>
                </label>
                <label class="flex items-center p-3 bg-gray-50 rounded-lg border has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer transition">
                    <input type="radio" name="publish-mode" value="results" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${publishMode === 'results' ? 'checked' : ''}>
                    <span class="ml-3 text-sm font-medium text-gray-800">Show Results Chart</span>
                </label>
                <label class="flex items-center p-3 bg-gray-50 rounded-lg border has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400 cursor-pointer transition">
                    <input type="radio" name="publish-mode" value="ballots" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${publishMode === 'ballots' ? 'checked' : ''}>
                    <span class="ml-3 text-sm font-medium text-gray-800">Show Live Voter Ballots</span>
                </label>
            `;
            publishOptionsContainer.removeEventListener('change', handlePublishModeChange);
            publishOptionsContainer.addEventListener('change', handlePublishModeChange);
        }

        function updatePollControlUI(pollStatus) {
            pollControlBtn.onclick = null; // Clear previous listener
            const canManageOptions = pollStatus === 'draft';
            manageOptionsSection.querySelectorAll('input, button').forEach(el => el.disabled = !canManageOptions);
            manageOptionsSection.style.opacity = canManageOptions ? '1' : '0.6';


            switch(pollStatus) {
                case 'draft':
                    pollStatusText.textContent = 'Draft';
                    pollStatusText.className = 'font-bold text-gray-600';
                    pollControlBtn.textContent = 'Start Poll';
                    pollControlBtn.className = 'w-full text-white font-semibold py-2 px-4 rounded-lg transition active:scale-95 bg-green-500 hover:bg-green-600';
                    pollControlBtn.onclick = () => handlePollStatusChange('open', 'Are you sure you want to start the poll? This will make it visible to voters.');
                    break;
                case 'open':
                    pollStatusText.textContent = 'Live';
                    pollStatusText.className = 'font-bold text-green-600 animate-pulse';
                    pollControlBtn.textContent = 'End Poll';
                    pollControlBtn.className = 'w-full text-white font-semibold py-2 px-4 rounded-lg transition active:scale-95 bg-red-500 hover:bg-red-600';
                    pollControlBtn.onclick = () => handlePollStatusChange('closed', 'Are you sure you want to end the poll? Voters will no longer be able to vote.');
                    break;
                case 'closed':
                    pollStatusText.textContent = 'Ended';
                    pollStatusText.className = 'font-bold text-red-600';
                    pollControlBtn.textContent = 'Poll Ended';
                    pollControlBtn.className = 'w-full text-white font-semibold py-2 px-4 rounded-lg transition active:scale-95 bg-gray-500';
                    pollControlBtn.disabled = true;
                    break;
            }
        }
        
        // --- Event Handlers ---
        async function handleAddOption() {
            const optionName = newOptionInput.value.trim();
            if (optionName) {
                try {
                    const pollData = (await getDoc(pollRef)).data();
                    const options = pollData.options || [];
                    if (options.some(opt => opt.name === optionName)) {
                        alert("This option already exists.");
                        return;
                    }
                    const newOption = { id: crypto.randomUUID(), name: optionName, votes: 0 };
                    await updateDoc(pollRef, { options: [...options, newOption] });
                    newOptionInput.value = '';
                } catch (error) {
                    console.error("Error adding option:", error);
                }
            }
        }

        function handleDeleteOption(optionId, optionName) {
            showModal(
                'Delete Option',
                `Are you sure you want to remove "${optionName}"? This will also remove its votes.`,
                async () => {
                    try {
                        const pollData = (await getDoc(pollRef)).data();
                        const updatedOptions = pollData.options.filter(opt => opt.id !== optionId);
                        await updateDoc(pollRef, { options: updatedOptions });
                    } catch (error) {
                        console.error("Error deleting option:", error);
                    }
                }
            );
        }

        function handleResetVotes() {
            showModal(
                'Reset Poll',
                'This will reset all votes, clear ballots, and return the poll to Draft mode. Are you sure?',
                async () => {
                    try {
                        const pollData = (await getDoc(pollRef)).data();
                        const resetOptions = pollData.options.map(opt => ({ ...opt, votes: 0 }));
                        await updateDoc(pollRef, { 
                            options: resetOptions,
                            ballots: [],
                            pollSessionId: crypto.randomUUID(),
                            pollStatus: 'draft'
                        });
                    } catch (error) {
                        console.error("Error resetting poll:", error);
                    }
                }
            );
        }

        async function handlePublishModeChange(event) {
            if (event.target.name === 'publish-mode') {
                const newMode = event.target.value;
                try {
                    await updateDoc(pollRef, { publishMode: newMode });
                } catch (error) {
                    console.error("Error updating publish mode:", error);
                }
            }
        }

        function handlePollStatusChange(newStatus, confirmationMessage) {
            showModal(
                'Confirm Action',
                confirmationMessage,
                async () => {
                    try {
                         await updateDoc(pollRef, { pollStatus: newStatus });
                    } catch (error) {
                        console.error(`Error updating poll status to ${newStatus}:`, error);
                    }
                }
            );
        }

        // --- Modal Functions ---
        function showModal(title, body, onConfirm) {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            confirmCallback = onConfirm;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
            }, 10);
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                confirmCallback = null;
            }, 200);
        }

    </script>
</body>
</html>

